---
import Layout from '../layouts/Layout.astro';
import { requireAuth } from '../lib/auth';
import db from '../lib/db';

const session = requireAuth(Astro.cookies);
if (!session) {
  return Astro.redirect('/login');
}

const userPosts = db.prepare(`
  SELECT * FROM posts 
  WHERE author_id = ? 
  ORDER BY created_at DESC
`).all(session.id);

const commentCount = db.prepare(`
  SELECT COUNT(*) as count FROM comments 
  WHERE post_id IN (SELECT id FROM posts WHERE author_id = ?)
`).get(session.id) as any;
---

<Layout title="Dashboard">
  <div class="container my-5">
    <div class="mb-4">
      <h1 class="display-4 gradient-text font-weight-bold">Welcome back, {session.username}!</h1>
      <p class="text-muted">Manage your posts and see your stats</p>
    </div>

    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
          <div class="card-body">
            <h6 class="card-subtitle mb-2" style="opacity: 0.9;">Total Posts</h6>
            <h2 class="card-title display-4 font-weight-bold">{userPosts.length}</h2>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);">
          <div class="card-body">
            <h6 class="card-subtitle mb-2" style="opacity: 0.9;">Comments</h6>
            <h2 class="card-title display-4 font-weight-bold">{commentCount.count}</h2>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
          <div class="card-body">
            <h6 class="card-subtitle mb-2" style="opacity: 0.9;">Member Since</h6>
            <h4 class="card-title font-weight-bold mt-3">
              {new Date(session.created_at || Date.now()).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
            </h4>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0 font-weight-bold">Your Posts</h4>
          <a href="/create-post" class="btn btn-gradient">
            <svg width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16" style="margin-bottom: 2px;">
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            New Post
          </a>
        </div>
      </div>
      <div class="card-body p-0">
        {userPosts.length === 0 ? (
          <div class="text-center py-5">
            <svg width="80" height="80" fill="currentColor" style="color: #dee2e6;" class="mb-3" viewBox="0 0 16 16">
              <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
              <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
            </svg>
            <h5 class="font-weight-bold">No posts yet</h5>
            <p class="text-muted mb-4">Start sharing your thoughts with the world!</p>
            <a href="/create-post" class="btn btn-gradient">Create Your First Post</a>
          </div>
        ) : (
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th>Title</th>
                  <th>Created</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {userPosts.map((post: any) => (
                  <tr>
                    <td>
                      <a href={`/post/${post.id}`} class="font-weight-bold" style="color: #667eea; text-decoration: none;">
                        {post.title}
                      </a>
                    </td>
                    <td class="text-muted">
                      {new Date(post.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </td>
                    <td class="text-right">
                      <a href={`/edit-post?id=${post.id}`} class="btn btn-sm btn-info mr-2">Edit</a>
                      <form method="POST" action="/api/posts/delete" class="d-inline" 
                            onsubmit="return confirm('Are you sure you want to delete this post?');">
                        <input type="hidden" name="postId" value={post.id}>
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                      </form>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>