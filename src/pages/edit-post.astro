---
import Layout from '../layouts/Layout.astro';
import { requireAuth } from '../lib/auth';
import db from '../lib/db';

const session = requireAuth(Astro.cookies);
if (!session) {
  return Astro.redirect('/login');
}

const postId = Astro.url.searchParams.get('id');
if (!postId) {
  return Astro.redirect('/dashboard');
}

const post = db.prepare('SELECT * FROM posts WHERE id = ? AND author_id = ?').get(postId, session.id);
if (!post) {
  return Astro.redirect('/dashboard');
}
---

<Layout title="Edit Post">
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="mb-4">
          <h1 class="display-4 gradient-text font-weight-bold">Edit Post</h1>
          <p class="text-muted">Update your content</p>
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-4">
            <form method="POST" action="/api/posts/update" enctype="application/x-www-form-urlencoded">
              <input type="hidden" name="postId" value={post.id}>
              
              <div class="form-group">
                <label for="title" class="font-weight-bold">Post Title</label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="title" 
                  name="title" 
                  value={post.title}
                  required
                >
              </div>
              
              <div class="form-group">
                <label for="content" class="font-weight-bold">Content</label>
                <textarea 
                  class="form-control" 
                  id="content" 
                  name="content" 
                  rows="16" 
                  required
                >{post.content}</textarea>
              </div>
              
              <div class="mt-4">
                <button type="submit" class="btn btn-gradient btn-lg">Update Post</button>
                <a href="/dashboard" class="btn btn-secondary btn-lg ml-2">Cancel</a>
              </div>
            </form>
          </div>
        </div>

        <div class="alert alert-warning mt-4">
          <small>
            <svg width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            Last updated: {new Date(post.updated_at).toLocaleString()}
          </small>
        </div>
      </div>
    </div>
  </div>
</Layout>