---
import Layout from '../../layouts/Layout.astro';
import { getSession } from '../../lib/auth';
import { supabase } from '../../lib/supabase';

const session = getSession(Astro.cookies);
const { id } = Astro.params;

const { data: post } = await supabase
  .from('posts')
  .select('*, users(username)')
  .eq('id', id)
  .single();

if (!post) return Astro.redirect('/');

const { data: comments } = await supabase
  .from('comments')
  .select('*, users(username)')
  .eq('post_id', id)
  .order('created_at', { ascending: true });
---
<Layout title={post.title}>
    <h1>{post.title}</h1>
    <p>By {post.users.username}</p>
    {comments?.map((comment: any) => (
        <p>{comment.content} - <b>{comment.users.username}</b></p>
    ))}
</Layout>